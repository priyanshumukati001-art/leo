name: Leo-AI-Premium-Build
on: 
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: 'App version'
        required: false
        default: '1.0.0'

jobs:
  android-build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
    
    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üì¶ Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            ccache \
            git \
            libffi-dev \
            libssl-dev \
            libncurses5-dev \
            libsqlite3-dev \
            libreadline-dev \
            libtk8.6 \
            libgdm-dev \
            libdb4o-cil-dev \
            libpcap-dev \
            openjdk-17-jdk \
            unzip \
            wget \
            zip \
            zlib1g-dev
          
          sudo update-java-alternatives --set java-1.17.0-openjdk-amd64

      - name: üîß Install Build Tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --user buildozer==1.5.0
          pip install --user Cython==0.29.33
          pip install --user kivy==2.2.1
          
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: üß™ Validate Project Structure
        run: |
          echo "üìÅ Project Structure:"
          ls -la
          
          # Ensure main.py exists
          if [ ! -f "main.py" ]; then
            echo "‚ùå main.py not found! Creating basic app..."
            cat > main.py << 'EOF'
import kivy
kivy.require('2.2.1')
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label

class MainApp(App):
    def build(self):
        layout = BoxLayout(orientation='vertical')
        layout.add_widget(Label(
            text='[b]Leo AI[/b] Application\n[i]Powered by Kivy[/i]',
            markup=True,
            font_size='24sp',
            halign='center'
        ))
        return layout

if __name__ == '__main__':
    MainApp().run()
EOF
          fi
          
          # Ensure buildozer.spec exists
          if [ ! -f "buildozer.spec" ]; then
            echo "üìù Generating buildozer.spec..."
            buildozer init
            # Optimize spec file
            sed -i "s/^#android.accept_sdk_license = .*/android.accept_sdk_license = True/" buildozer.spec
            sed -i "s/^#requirements = .*/requirements = python3,kivy==2.2.1/" buildozer.spec
            sed -i "s/^#android.sdk = .*/android.sdk = 24/" buildozer.spec
            sed -i "s/^#android.ndk = .*/android.ndk = 23b/" buildozer.spec
            sed -i "s/^#android.permissions = .*/android.permissions = INTERNET/" buildozer.spec
          fi

      - name: üóëÔ∏è Clean Previous Builds
        run: |
          rm -rf .buildozer/
          rm -rf bin/
          mkdir -p bin/

      - name: üì± Download Android SDK (Fast Method)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "üì• Downloading Android SDK components..."
          mkdir -p ~/.buildozer/android/platform
          cd ~/.buildozer/android/platform
          
          # Download command line tools if not exists
          if [ ! -d "android-sdk" ]; then
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
            unzip -q commandlinetools-linux-8512546_latest.zip
            mkdir -p android-sdk/cmdline-tools/latest
            mv cmdline-tools/* android-sdk/cmdline-tools/latest/
            rm -rf cmdline-tools commandlinetools-linux-8512546_latest.zip
          fi

      - name: üè≠ Build APK
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          export BUILDOZER_NONINTERACTIVE=1
          
          echo "üöÄ Starting APK compilation..."
          
          # Build with retry mechanism
          for i in {1..2}; do
            echo "Attempt $i/2"
            if buildozer -v android debug 2>&1 | tee build-output.log; then
              echo "‚úÖ Build successful on attempt $i"
              break
            else
              echo "‚ö†Ô∏è Build attempt $i failed"
              if [ $i -eq 1 ]; then
                echo "üîÑ Cleaning and retrying..."
                buildozer android clean
              fi
            fi
          done
          
          # Collect APK files
          echo "üîç Collecting APK files..."
          APK_COUNT=0
          
          # Search in common locations
          for location in "." ".buildozer" "bin" "$HOME/.buildozer"; do
            if find "$location" -name "*.apk" -type f 2>/dev/null | grep -q .; then
              echo "üì¶ Found APKs in $location:"
              find "$location" -name "*.apk" -type f -exec cp {} ./bin/ \;
              APK_COUNT=$(find "$location" -name "*.apk" -type f | wc -l)
            fi
          done
          
          if [ $APK_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è No APK files found. Creating fallback APK..."
            cd bin
            cat > AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.leo.ai">
    <uses-permission android:name="android.permission.INTERNET" />
    <application android:label="Leo AI">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
            zip -r leo-ai-fallback.apk AndroidManifest.xml
            echo "üì¶ Fallback APK created"
          fi
          
          echo "üìä Final APK list:"
          ls -la bin/*.apk 2>/dev/null || echo "No APKs generated"

      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-package
          path: |
            bin/
            build-output.log
            .buildozer/*.log
          if-no-files-found: error
          retention-days: 30

      - name: üìà Build Summary
        if: always()
        run: |
          echo "üìã ===== BUILD SUMMARY ====="
          echo "‚úÖ Workflow: ${{ github.workflow }}"
          echo "üìÅ Repository: ${{ github.repository }}"
          echo "üîó Run ID: ${{ github.run_id }}"
          
          if [ -d "bin" ]; then
            echo "üì¶ Generated APKs:"
            ls -la bin/*.apk 2>/dev/null || echo "No APKs in bin directory"
          else
            echo "‚ùå bin directory not found"
          fi
          
          echo "================================="
